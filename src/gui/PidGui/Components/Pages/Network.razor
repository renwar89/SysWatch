@page "/network"
@implements IDisposable
@inject NetworkScannerService NetworkScanner

<PageTitle>Network Connections</PageTitle>

@{
    var filtered = FilteredConnections().ToList();
    var summaries = BuildProcessSummaries(filtered);
    var tree = BuildProcessTree(summaries, _collapsed);
    var display = _pageSize <= 0 ? tree : tree.Take(_pageSize).ToList();
    var topProcesses = GetTopProcesses(filtered);
    var summaryCount = summaries.Count;
    var total = _connections.Count;
    var established = _connections.Count(c => string.Equals(c.State, "ESTABLISHED", StringComparison.OrdinalIgnoreCase));
    var listening = _connections.Count(c => string.Equals(c.State, "LISTENING", StringComparison.OrdinalIgnoreCase));
    var maxValue = Math.Max(1, _samples.Select(s => s.Total).DefaultIfEmpty(0).Max());
    var midValue = (int)Math.Round(maxValue / 2.0);
    var uniqueRemotes = _connections.Select(c => c.RemoteAddress)
        .Where(addr => !string.IsNullOrWhiteSpace(addr) && addr != "*" && addr != "0.0.0.0" && addr != "::")
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .Count();
}

<div class="page">
    <div class="page-wrapper">
        <div class="page-header d-print-none">
            <div class="container-xl">
                <div class="row g-2 align-items-center">
                    <div class="col">
                        <div class="page-pretitle">Realtime</div>
                        <h2 class="page-title">Network Connections</h2>
                        <div class="page-subtitle">
                            <span class="badge badge-outline-primary">@total total</span>
                            <span class="text-muted">Auto refresh @(_autoRefresh ? $"{_refreshMs}ms" : "off")</span>
                            @if (_lastUpdated is not null)
                            {
                                <span class="text-muted">Updated @_lastUpdated.Value.ToLocalTime().ToString("HH:mm:ss")</span>
                            }
                        </div>
                    </div>
                    <div class="col-auto ms-auto">
                        <div class="btn-list">
                            <button class="btn btn-primary" @onclick="RefreshAsync" disabled="@_isLoading">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"></path>
                                    <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                                </svg>
                                Refresh
                            </button>
                            <button class="btn" @onclick="ToggleAutoRefresh">
                                @if (_autoRefresh)
                                {
                                    <span>Pause Auto-Refresh</span>
                                }
                                else
                                {
                                    <span>Start Auto-Refresh</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-body">
            <div class="container-xl">
                <div class="row row-deck row-cards">
                    <div class="col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Total Connections</div>
                                    <div class="ms-auto lh-1">
                                        <span class="badge badge-primary">@total</span>
                                    </div>
                                </div>
                                <div class="stat-value">@total</div>
                                <div class="stat-meta">Across all processes</div>
                                <div class="progress progress-sm">
                                    <div class="progress-bar bg-primary" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Established</div>
                                    <div class="ms-auto lh-1">
                                        <span class="badge badge-success">@established</span>
                                    </div>
                                </div>
                                <div class="stat-value">@established</div>
                                <div class="stat-meta">Active sessions</div>
                                <div class="progress progress-sm">
                                    <div class="progress-bar bg-success" style="width: @ToPercent(established, total)%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Listening</div>
                                    <div class="ms-auto lh-1">
                                        <span class="badge badge-warning">@listening</span>
                                    </div>
                                </div>
                                <div class="stat-value">@listening</div>
                                <div class="stat-meta">Open ports</div>
                                <div class="progress progress-sm">
                                    <div class="progress-bar bg-warning" style="width: @ToPercent(listening, total)%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="subheader">Unique Remotes</div>
                                    <div class="ms-auto lh-1">
                                        <span class="badge badge-secondary">@uniqueRemotes</span>
                                    </div>
                                </div>
                                <div class="stat-value">@uniqueRemotes</div>
                                <div class="stat-meta">Remote endpoints</div>
                                <div class="progress progress-sm">
                                    <div class="progress-bar bg-secondary" style="width: 70%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Realtime Connection Flow</h3>
                                <div class="card-actions">
                                    <span class="badge badge-outline-primary">Last @_samples.Count samples</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <svg class="sparkline sparkline-wide" viewBox="0 0 100 20" preserveAspectRatio="none">
                                    <line class="sparkline-grid" x1="6" y1="2" x2="98" y2="2" />
                                    <line class="sparkline-grid" x1="6" y1="10" x2="98" y2="10" />
                                    <line class="sparkline-grid" x1="6" y1="18" x2="98" y2="18" />
                                    <line class="sparkline-axis" x1="6" y1="2" x2="6" y2="18" />
                                    <line class="sparkline-axis" x1="6" y1="18" x2="98" y2="18" />
                                    <text class="axis-label" x="0" y="4">@maxValue</text>
                                    <text class="axis-label" x="0" y="12">@midValue</text>
                                    <text class="axis-label" x="0" y="18.5">0</text>
                                    <text class="axis-caption axis-caption-y" x="8" y="5">connections</text>
                                    <text class="axis-caption axis-caption-x" x="52" y="18.5">time</text>
                                    <polyline points="@BuildPolyline(_samples.Select(s => s.Total), maxValue)" class="sparkline-line sparkline-total" />
                                    <polyline points="@BuildPolyline(_samples.Select(s => s.Established), maxValue)" class="sparkline-line sparkline-established" />
                                    <polyline points="@BuildPolyline(_samples.Select(s => s.Listening), maxValue)" class="sparkline-line sparkline-listening" />
                                </svg>
                                <div class="legend">
                                    <span><i class="legend-dot legend-total"></i>Total</span>
                                    <span><i class="legend-dot legend-established"></i>Established</span>
                                    <span><i class="legend-dot legend-listening"></i>Listening</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Top Processes</h3>
                            </div>
                            <div class="card-body">
                                @if (topProcesses.Count == 0)
                                {
                                    <div class="empty">
                                        <div class="empty-icon">o</div>
                                        <div class="empty-title">No data yet</div>
                                        <div class="empty-subtitle">Refresh to capture connections.</div>
                                    </div>
                                }
                                else
                                {
                                    @for (var i = 0; i < topProcesses.Count; i++)
                                    {
                                        var item = topProcesses[i];
                                        var rank = i + 1;
                                        <div class="metric-row metric-row-card">
                                            <div class="metric-rank">#@rank</div>
                                            <div class="metric-label text-truncate">@item.Name</div>
                                            <div class="metric-bar">
                                                <div class="progress progress-sm">
                                                    <div class="progress-bar bg-primary" style="width: @ToPercent(item.Count, topProcesses[0].Count)%"></div>
                                                </div>
                                            </div>
                                            <div class="metric-value">@item.Count</div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Connection Filters</h3>
                                <div class="card-actions">
                                    <span class="badge badge-outline-primary">@filtered.Count shown</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Search</label>
                                            <input type="text" class="form-control" placeholder="Process, PID, remote IP..." @bind="_searchText" @bind:event="oninput" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">State</label>
                                            <select class="form-select" @bind="_stateFilter">
                                                <option value="all">All states</option>
                                                <option value="established">Established</option>
                                                <option value="listening">Listening</option>
                                                <option value="udp">UDP</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Rows per page</label>
                                            <select class="form-select" @bind="_pageSize">
                                                <option value="100">100</option>
                                                <option value="200">200</option>
                                                <option value="500">500</option>
                                                <option value="0">All</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Refresh cadence</label>
                                        <select class="form-select" @bind="_refreshMs" @bind:after="OnRefreshIntervalChanged">
                                            <option value="1000">1 sec</option>
                                            <option value="2000">2 sec</option>
                                            <option value="5000">5 sec</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Hide loopback</label>
                                        <div class="btn-list">
                                            <button class="btn @(_hideLoopback ? "btn-primary" : string.Empty)" @onclick="ToggleLoopback">
                                                @(_hideLoopback ? "Loopback hidden" : "Hide loopback")
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Connections by Process</h3>
                                <div class="card-actions">
                                    <span class="text-muted">@display.Count of @summaryCount</span>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-vcenter card-table">
                                    <thead>
                                        <tr>
                                            <th>Process</th>
                                            <th>Total</th>
                                            <th>Established</th>
                                            <th>Listening</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (display.Count == 0)
                                        {
                                            <tr>
                                                <td colspan="5">
                                                    <div class="empty">
                                                        <div class="empty-icon">o</div>
                                                        <div class="empty-title">No processes found</div>
                                                        <div class="empty-subtitle">Adjust filters or refresh to see data.</div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                        else
                                        {
                                            @foreach (var node in display)
                                            {
                                                var summary = node.Summary;
                                                var isCollapsed = _collapsed.Contains(summary.Pid);
                                                var totalValue = isCollapsed ? node.SubtreeTotal : summary.Total;
                                                var establishedValue = isCollapsed ? node.SubtreeEstablished : summary.Established;
                                                var listeningValue = isCollapsed ? node.SubtreeListening : summary.Listening;
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center tree-indent" style="--depth: @node.Depth; --tree-line-opacity: @(node.Depth == 0 ? 0 : 1)">
                                                            <button class="tree-toggle" disabled="@(!node.HasChildren)" @onclick="() => ToggleCollapsed(summary.Pid)">
                                                                @if (node.HasChildren)
                                                                {
                                                                    <span>@(isCollapsed ? "+" : "-")</span>
                                                                }
                                                            </button>
                                                            <span class="status-dot @ConnectionDotClass(totalValue, establishedValue, listeningValue)"></span>
                                                            <div class="flex-fill">
                                                                <div class="font-weight-medium">@summary.Name</div>
                                                                <div class="text-muted small">PID @summary.Pid</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td><span class="badge badge-primary">@totalValue</span></td>
                                                    <td><span class="badge badge-success">@establishedValue</span></td>
                                                    <td><span class="badge badge-warning">@listeningValue</span></td>
                                                    <td>
                                                        <button class="btn btn-sm btn-icon" title="Toggle details" @onclick="() => ToggleExpanded(summary.Pid)">
                                                            @if (_expanded.Contains(summary.Pid))
                                                            {
                                                                <span>-</span>
                                                            }
                                                            else
                                                            {
                                                                <span>+</span>
                                                            }
                                                        </button>
                                                    </td>
                                                </tr>
                                                @if (_expanded.Contains(summary.Pid))
                                                {
                                                    <tr class="detail-row">
                                                        <td colspan="5">
                                                            <div class="detail-block">
                                                                <div class="detail-title">Connections</div>
                                                                @if (summary.Connections.Count == 0)
                                                                {
                                                                    <div class="empty">
                                                                        <div class="empty-icon">o</div>
                                                                        <div class="empty-title">No connections</div>
                                                                        <div class="empty-subtitle">This process has no active sockets.</div>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <div class="table-responsive">
                                                                        <table class="table table-vcenter connection-table">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Protocol</th>
                                                                                    <th>Local</th>
                                                                                    <th>Remote</th>
                                                                                    <th>State</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                @foreach (var conn in summary.Connections)
                                                                                {
                                                                                    <tr>
                                                                                        <td>@conn.Protocol</td>
                                                                                        <td class="text-muted"><small>@FormatEndpoint(conn.LocalAddress, conn.LocalPort)</small></td>
                                                                                        <td class="text-muted"><small>@FormatEndpoint(conn.RemoteAddress, conn.RemotePort)</small></td>
                                                                                        <td>
                                                                                            <span class="status-dot @StateDot(conn)"></span>
                                                                                            <span class="ms-2">@GetStateLabel(conn)</span>
                                                                                        </td>
                                                                                    </tr>
                                                                                }
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                }
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                            @if (_pageSize > 0 && summaryCount > _pageSize)
                            {
                                <div class="card-footer">
                                    <span class="text-muted">Showing @_pageSize of @summaryCount processes</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private sealed record NetworkSample(DateTime TimestampUtc, int Total, int Established, int Listening);
    private sealed record ProcessSummary(
        int Pid,
        string Name,
        int? ParentId,
        int Total,
        int Established,
        int Listening,
        int Udp,
        IReadOnlyList<NetworkConnectionInfo> Connections);
    private sealed record ProcessNode(
        ProcessSummary Summary,
        int Depth,
        bool HasChildren,
        int SubtreeTotal,
        int SubtreeEstablished,
        int SubtreeListening,
        int SubtreeUdp);

    private readonly List<NetworkConnectionInfo> _connections = new();
    private readonly List<NetworkSample> _samples = new();
    private string _searchText = string.Empty;
    private string _stateFilter = "all";
    private bool _hideLoopback = true;
    private bool _autoRefresh = true;
    private int _refreshMs = 2000;
    private int _pageSize = 200;
    private bool _isLoading;
    private DateTime? _lastUpdated;
    private CancellationTokenSource? _refreshCts;
    private readonly SemaphoreSlim _refreshLock = new(1, 1);
    private readonly HashSet<int> _collapsed = new();
    private readonly HashSet<int> _expanded = new();
    private bool _collapseInitialized;

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
        StartAutoRefresh();
    }

    private async Task RefreshAsync()
    {
        if (!await _refreshLock.WaitAsync(0))
        {
            return;
        }

        try
        {
            _isLoading = true;
            var snapshot = await NetworkScanner.GetConnectionsAsync();
            _connections.Clear();
            _connections.AddRange(snapshot);
            _lastUpdated = DateTime.UtcNow;
            var alive = _connections.Select(c => c.Pid).ToHashSet();
            _expanded.RemoveWhere(id => !alive.Contains(id));
            _collapsed.RemoveWhere(id => !alive.Contains(id));
            if (!_collapseInitialized)
            {
                var parents = _connections
                    .Select(c => c.ParentId)
                    .Where(pid => pid.HasValue && alive.Contains(pid.Value))
                    .Select(pid => pid!.Value)
                    .ToHashSet();
                _collapsed.UnionWith(parents);
                _collapseInitialized = true;
            }
            UpdateSamples();
        }
        finally
        {
            _isLoading = false;
            _refreshLock.Release();
        }
    }

    private void UpdateSamples()
    {
        var total = _connections.Count;
        var established = _connections.Count(c => string.Equals(c.State, "ESTABLISHED", StringComparison.OrdinalIgnoreCase));
        var listening = _connections.Count(c => string.Equals(c.State, "LISTENING", StringComparison.OrdinalIgnoreCase));
        _samples.Add(new NetworkSample(DateTime.UtcNow, total, established, listening));
        if (_samples.Count > 60)
        {
            _samples.RemoveRange(0, _samples.Count - 60);
        }
    }

    private void StartAutoRefresh()
    {
        _refreshCts?.Cancel();
        _refreshCts?.Dispose();
        _refreshCts = null;

        if (!_autoRefresh)
        {
            return;
        }

        _refreshCts = new CancellationTokenSource();
        var token = _refreshCts.Token;
        _ = Task.Run(async () =>
        {
            using var timer = new PeriodicTimer(TimeSpan.FromMilliseconds(_refreshMs));
            try
            {
                while (await timer.WaitForNextTickAsync(token))
                {
                    await InvokeAsync(async () =>
                    {
                        await RefreshAsync();
                        StateHasChanged();
                    });
                }
            }
            catch (OperationCanceledException)
            {
                // Expected when auto-refresh is toggled off or component disposed.
            }
        }, token);
    }

    private void OnRefreshIntervalChanged()
    {
        StartAutoRefresh();
    }

    private void ToggleAutoRefresh()
    {
        _autoRefresh = !_autoRefresh;
        StartAutoRefresh();
    }

    private void ToggleLoopback()
    {
        _hideLoopback = !_hideLoopback;
    }

    private IEnumerable<NetworkConnectionInfo> FilteredConnections()
    {
        var filtered = _connections.AsEnumerable();

        if (_hideLoopback)
        {
            filtered = filtered.Where(c => !IsLoopback(c.RemoteAddress));
        }

        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            var token = _searchText.Trim();
            filtered = filtered.Where(c =>
                (c.ProcessName?.Contains(token, StringComparison.OrdinalIgnoreCase) ?? false) ||
                c.Pid.ToString().Contains(token, StringComparison.OrdinalIgnoreCase) ||
                c.LocalAddress.Contains(token, StringComparison.OrdinalIgnoreCase) ||
                c.RemoteAddress.Contains(token, StringComparison.OrdinalIgnoreCase));
        }

        filtered = _stateFilter switch
        {
            "established" => filtered.Where(c => string.Equals(c.State, "ESTABLISHED", StringComparison.OrdinalIgnoreCase)),
            "listening" => filtered.Where(c => string.Equals(c.State, "LISTENING", StringComparison.OrdinalIgnoreCase)),
            "udp" => filtered.Where(c => string.Equals(c.Protocol, "UDP", StringComparison.OrdinalIgnoreCase)),
            _ => filtered
        };

        return filtered.OrderBy(c => c.ProcessName).ThenBy(c => c.Pid);
    }

    private static List<ProcessSummary> BuildProcessSummaries(IEnumerable<NetworkConnectionInfo> connections)
    {
        var summaries = new List<ProcessSummary>();
        foreach (var group in connections.GroupBy(conn => conn.Pid))
        {
            var list = group.ToList();
            var sample = list[0];
            var established = list.Count(conn => string.Equals(conn.State, "ESTABLISHED", StringComparison.OrdinalIgnoreCase));
            var listening = list.Count(conn => string.Equals(conn.State, "LISTENING", StringComparison.OrdinalIgnoreCase));
            var udp = list.Count(conn => string.Equals(conn.Protocol, "UDP", StringComparison.OrdinalIgnoreCase));

            summaries.Add(new ProcessSummary(
                group.Key,
                GetProcessLabel(sample),
                sample.ParentId,
                list.Count,
                established,
                listening,
                udp,
                list));
        }

        return summaries
            .OrderByDescending(summary => summary.Total)
            .ThenBy(summary => summary.Name)
            .ToList();
    }

    private static List<ProcessNode> BuildProcessTree(IReadOnlyList<ProcessSummary> summaries, HashSet<int> collapsed)
    {
        var result = new List<ProcessNode>();
        if (summaries.Count == 0)
        {
            return result;
        }

        var index = summaries.Select((summary, idx) => (summary.Pid, idx))
            .ToDictionary(item => item.Pid, item => item.idx);

        var byId = summaries.ToDictionary(summary => summary.Pid);
        var children = new Dictionary<int, List<ProcessSummary>>();
        var roots = new List<ProcessSummary>();

        foreach (var summary in summaries)
        {
            if (summary.ParentId is int parentId && byId.ContainsKey(parentId))
            {
                if (!children.TryGetValue(parentId, out var list))
                {
                    list = new List<ProcessSummary>();
                    children[parentId] = list;
                }

                list.Add(summary);
            }
            else
            {
                roots.Add(summary);
            }
        }

        roots.Sort((a, b) => index[a.Pid].CompareTo(index[b.Pid]));
        foreach (var list in children.Values)
        {
            list.Sort((a, b) => index[a.Pid].CompareTo(index[b.Pid]));
        }

        var subtreeTotal = new Dictionary<int, int>();
        var subtreeEstablished = new Dictionary<int, int>();
        var subtreeListening = new Dictionary<int, int>();
        var subtreeUdp = new Dictionary<int, int>();

        int ComputeTotal(ProcessSummary summary)
        {
            var total = summary.Total;
            if (children.TryGetValue(summary.Pid, out var list))
            {
                foreach (var child in list)
                {
                    total += ComputeTotal(child);
                }
            }

            subtreeTotal[summary.Pid] = total;
            return total;
        }

        int ComputeEstablished(ProcessSummary summary)
        {
            var total = summary.Established;
            if (children.TryGetValue(summary.Pid, out var list))
            {
                foreach (var child in list)
                {
                    total += ComputeEstablished(child);
                }
            }

            subtreeEstablished[summary.Pid] = total;
            return total;
        }

        int ComputeListening(ProcessSummary summary)
        {
            var total = summary.Listening;
            if (children.TryGetValue(summary.Pid, out var list))
            {
                foreach (var child in list)
                {
                    total += ComputeListening(child);
                }
            }

            subtreeListening[summary.Pid] = total;
            return total;
        }

        int ComputeUdp(ProcessSummary summary)
        {
            var total = summary.Udp;
            if (children.TryGetValue(summary.Pid, out var list))
            {
                foreach (var child in list)
                {
                    total += ComputeUdp(child);
                }
            }

            subtreeUdp[summary.Pid] = total;
            return total;
        }

        foreach (var root in roots)
        {
            ComputeTotal(root);
            ComputeEstablished(root);
            ComputeListening(root);
            ComputeUdp(root);
        }

        void Walk(ProcessSummary summary, int depth)
        {
            var hasChildren = children.TryGetValue(summary.Pid, out var list) && list.Count > 0;
            result.Add(new ProcessNode(
                summary,
                depth,
                hasChildren,
                subtreeTotal.TryGetValue(summary.Pid, out var total) ? total : summary.Total,
                subtreeEstablished.TryGetValue(summary.Pid, out var established) ? established : summary.Established,
                subtreeListening.TryGetValue(summary.Pid, out var listening) ? listening : summary.Listening,
                subtreeUdp.TryGetValue(summary.Pid, out var udp) ? udp : summary.Udp));

            if (hasChildren && !collapsed.Contains(summary.Pid))
            {
                foreach (var child in list!)
                {
                    Walk(child, depth + 1);
                }
            }
        }

        foreach (var root in roots)
        {
            Walk(root, 0);
        }

        return result;
    }

    private void ToggleCollapsed(int pid)
    {
        if (!_collapsed.Add(pid))
        {
            _collapsed.Remove(pid);
        }
    }

    private void ToggleExpanded(int pid)
    {
        if (!_expanded.Add(pid))
        {
            _expanded.Remove(pid);
        }
    }

    private static bool IsLoopback(string address)
    {
        return address == "127.0.0.1" || address == "::1" || address.StartsWith("127.", StringComparison.Ordinal);
    }

    private static string FormatEndpoint(string address, int port)
    {
        if (string.IsNullOrWhiteSpace(address))
        {
            return "-";
        }

        if (port <= 0)
        {
            return address;
        }

        return address.Contains(":", StringComparison.Ordinal) && !address.Contains("]", StringComparison.Ordinal)
            ? $"[{address}]:{port}"
            : $"{address}:{port}";
    }

    private static string GetProcessLabel(NetworkConnectionInfo conn)
    {
        if (!string.IsNullOrWhiteSpace(conn.ProcessName))
        {
            return conn.ProcessName.EndsWith(".exe", StringComparison.OrdinalIgnoreCase)
                ? conn.ProcessName
                : conn.ProcessName + ".exe";
        }

        return "unknown.exe";
    }

    private static string GetStateLabel(NetworkConnectionInfo conn)
    {
        if (string.Equals(conn.Protocol, "UDP", StringComparison.OrdinalIgnoreCase))
        {
            return "UDP";
        }

        return string.IsNullOrWhiteSpace(conn.State) ? "-" : conn.State!;
    }

    private static string StateDot(NetworkConnectionInfo conn)
    {
        if (string.Equals(conn.State, "ESTABLISHED", StringComparison.OrdinalIgnoreCase))
        {
            return "status-dot-green";
        }

        if (string.Equals(conn.State, "LISTENING", StringComparison.OrdinalIgnoreCase))
        {
            return "status-dot-yellow";
        }

        return "status-dot-red";
    }

    private static string ConnectionDotClass(int total, int established, int listening)
    {
        if (established > 0)
        {
            return "status-dot-green";
        }

        if (listening > 0)
        {
            return "status-dot-yellow";
        }

        return total > 0 ? "status-dot-red" : "status-dot-green";
    }

    private static IReadOnlyList<(string Name, int Count)> GetTopProcesses(IEnumerable<NetworkConnectionInfo> connections)
    {
        return connections
            .GroupBy(c => string.IsNullOrWhiteSpace(c.ProcessName) ? "unknown" : c.ProcessName!)
            .OrderByDescending(group => group.Count())
            .Take(6)
            .Select(group => (group.Key, group.Count()))
            .ToList();
    }

    private static string BuildPolyline(IEnumerable<int> values, int maxValue)
    {
        var list = values.ToList();
        if (list.Count == 0)
        {
            return string.Empty;
        }

        var max = Math.Max(1, maxValue);
        const double plotLeft = 6;
        const double plotRight = 98;
        const double plotTop = 2;
        const double plotBottom = 18;
        var width = plotRight - plotLeft;
        var height = plotBottom - plotTop;
        var step = list.Count == 1 ? 0 : width / (list.Count - 1);

        return string.Join(" ", list.Select((value, index) =>
        {
            var x = plotLeft + (step * index);
            var y = plotBottom - (value / (double)max * height);
            return $"{x:0.#},{y:0.#}";
        }));
    }

    private static double ToPercent(int value, int total)
    {
        if (total <= 0)
        {
            return 0;
        }

        return Math.Min(100, Math.Max(0, value * 100.0 / total));
    }

    public void Dispose()
    {
        _refreshCts?.Cancel();
        _refreshCts?.Dispose();
        _refreshLock.Dispose();
    }
}
